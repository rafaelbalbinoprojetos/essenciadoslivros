-- =============================================================
-- ğŸš€ BANCO DE DADOS - ESSÃŠNCIA DOS LIVROS
-- Criado para Supabase (PostgreSQL)
-- =============================================================

-- Ativar extensÃ£o para UUIDs (se ainda nÃ£o estiver ativa)
create extension if not exists "uuid-ossp";

-- =============================================================
-- ğŸ§© TABELA: autores
-- =============================================================
create table if not exists autores (
  id uuid primary key default uuid_generate_v4(),
  nome text not null,
  bio text,
  foto_url text,
  nacionalidade text,
  data_nascimento date,
  criado_em timestamp default now()
);

-- =============================================================
-- ğŸ·ï¸ TABELA: generos
-- =============================================================
create table if not exists generos (
  id uuid primary key default uuid_generate_v4(),
  nome text not null unique,
  descricao text,
  icone text,
  criado_em timestamp default now()
);

-- =============================================================
-- ğŸ§± TABELA: colecoes
-- =============================================================
create table if not exists colecoes (
  id uuid primary key default uuid_generate_v4(),
  nome text not null,
  descricao text,
  capa_url text,
  criado_em timestamp default now()
);

-- =============================================================
-- ğŸ“˜ TABELA: livros
-- =============================================================
create table if not exists livros (
  id uuid primary key default uuid_generate_v4(),
  titulo text not null,
  subtitulo text,
  autor_id uuid references autores(id) on delete set null,
  genero_id uuid references generos(id) on delete set null,
  colecao_id uuid references colecoes(id) on delete set null,
  sinopse text,
  capa_url text,
  pdf_url text,
  audio_url text,
  duracao_audio numeric,
  data_lancamento date,
  data_adicao timestamp default now(),
  status text default 'ativo',
  destaque boolean default false,
  criado_em timestamp default now(),
  atualizado_em timestamp default now()
);

-- =============================================================
-- ğŸ§ TABELA: progresso_leitura
-- =============================================================
create table if not exists progresso_leitura (
  id uuid primary key default uuid_generate_v4(),
  usuario_id uuid references auth.users(id) on delete cascade,
  livro_id uuid references livros(id) on delete cascade,
  tipo text check (tipo in ('leitura', 'audio')),
  progresso_percentual numeric default 0,
  tempo_reproduzido numeric default 0,
  ultima_atividade timestamp default now(),
  unique (usuario_id, livro_id, tipo)
);

-- =============================================================
-- â­ TABELA: avaliacoes
-- =============================================================
create table if not exists avaliacoes (
  id uuid primary key default uuid_generate_v4(),
  usuario_id uuid references auth.users(id) on delete cascade,
  livro_id uuid references livros(id) on delete cascade,
  nota numeric check (nota between 0 and 5),
  comentario text,
  criado_em timestamp default now(),
  unique (usuario_id, livro_id)
);

-- =============================================================
-- ğŸ’° TABELA: assinaturas
-- =============================================================
create table if not exists assinaturas (
  id uuid primary key default uuid_generate_v4(),
  usuario_id uuid references auth.users(id) on delete cascade,
  plano text check (plano in ('Free', 'EssÃªncia Plus', 'EssÃªncia Premium')),
  ativo boolean default true,
  data_inicio timestamp default now(),
  data_fim timestamp,
  pagamento_id text,
  criado_em timestamp default now()
);

-- =============================================================
-- âš™ï¸ TRIGGER: atualizar "atualizado_em" automaticamente
-- =============================================================
create or replace function update_timestamp()
returns trigger as $$
begin
  new.atualizado_em = now();
  return new;
end;
$$ language plpgsql;

create trigger update_livros_timestamp
before update on livros
for each row
execute procedure update_timestamp();

-- =============================================================
-- ğŸ”’ POLÃTICAS DE SEGURANÃ‡A (RLS)
-- =============================================================
alter table progresso_leitura enable row level security;
alter table avaliacoes enable row level security;
alter table assinaturas enable row level security;

-- Permitir que o usuÃ¡rio veja e altere apenas seus prÃ³prios registros
create policy "UsuÃ¡rio vÃª apenas seu progresso"
  on progresso_leitura
  for select using (auth.uid() = usuario_id);

create policy "UsuÃ¡rio altera apenas seu progresso"
  on progresso_leitura
  for update using (auth.uid() = usuario_id);

create policy "UsuÃ¡rio cria progresso prÃ³prio"
  on progresso_leitura
  for insert with check (auth.uid() = usuario_id);

create policy "UsuÃ¡rio vÃª apenas suas avaliaÃ§Ãµes"
  on avaliacoes
  for select using (auth.uid() = usuario_id);

create policy "UsuÃ¡rio cria avaliaÃ§Ã£o prÃ³pria"
  on avaliacoes
  for insert with check (auth.uid() = usuario_id);

create policy "UsuÃ¡rio atualiza apenas suas avaliaÃ§Ãµes"
  on avaliacoes
  for update using (auth.uid() = usuario_id);

create policy "UsuÃ¡rio vÃª apenas sua assinatura"
  on assinaturas
  for select using (auth.uid() = usuario_id);

create policy "UsuÃ¡rio cria/atualiza assinatura prÃ³pria"
  on assinaturas
  for all using (auth.uid() = usuario_id);

-- =============================================================
-- ğŸ”š FIM DO SCRIPT
-- =============================================================


insert into generos (nome) values
('AÃ§Ã£o'), ('Romance'), ('Filosofia'), ('Drama'), ('Biografia'), ('TÃ©cnico'), ('Fantasia');
